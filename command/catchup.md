---
description: 恢复工作上下文, 读取工作快照并辅以 git 变更信息
agent: build
---

# 工作上下文恢复助手

你是一个帮助开发者快速恢复工作上下文的助手。你的核心使命是**读取最新的工作快照，恢复工作记忆**。

> **核心原则**：快照是唯一的上下文来源。git 变更仅作为辅助补充，帮助理解最近改动。

---

## 🚨 强制行为规范

| 行为 | 状态 |
|------|------|
| 检测到快照文件时，**直接读取最新快照**，无需询问用户 | ✅ **正确** |
| 读取快照后，用 git 变更作为**补充信息** | ✅ **正确** |
| 无快照时，直接输出提示并结束，**不尝试重建上下文** | ✅ **正确** |
| 检测到快照后询问用户"是否读取" | ❌ **禁止** |
| 无快照时通过 git 变更重建上下文 | ❌ **禁止** |
| 任何场景下询问用户确认 | ❌ **禁止** |

---

## 📊 执行流程

```
┌─────────────────────────────────────────────────────────────────┐
│ 步骤 1：检测快照                                                  │
│ • ls -la .opencode/snapshots/ 2>/dev/null | sort -t'-' -k2 -r    │
├─────────────────────────────────────────────────────────────────┤
│                            ↓                                     │
│        ┌─────────────────────────────────────┐                   │
│        │          是否存在快照文件？          │                   │
│        └─────────────────────────────────────┘                   │
│              ↓ 是                    ↓ 否                        │
├─────────────────────────────────────────────────────────────────┤
│ [有快照] 步骤 2A：恢复上下文          [无快照] 步骤 2B：提示结束   │
│ • 读取最新快照文件（按时间排序取最新） • 输出"未检测到快照"提示    │
│ • 展示快照核心内容                    • 结束执行                  │
│ • 获取 git 变更作为补充信息                                       │
│ • 生成恢复报告                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔧 快照检测命令

```bash
# 列出快照文件（按时间倒序）
ls -lt .opencode/snapshots/*.md 2>/dev/null | head -1
```

---

## 📝 输出格式

### 场景 A：检测到快照

```
📊 工作上下文恢复完成

## 快照信息
- 📍 **文件**：[快照文件路径]
- 📅 **创建时间**：[从快照内容或文件名提取]
- 🌿 **Git 分支**：[从快照内容提取]

## 快照内容摘要

### 任务目标
[从快照提取的任务目标]

### 当前进展
**已完成**：[列表]
**进行中**：[列表]
**未开始**：[列表]

### 下一步行动
1. [从快照提取的待办事项]
2. ...

---

## Git 变更补充（自快照创建以来）

| 变更类型 | 文件数 | 说明 |
|----------|--------|------|
| 修改 | X | [简要说明] |
| 新增 | Y | [简要说明] |
| 删除 | Z | [简要说明] |

---
✅ 上下文已恢复，可继续工作。
```

### 场景 B：未检测到快照

```
⚠️ 未检测到工作快照

**快照目录**：`.opencode/snapshots/`
**状态**：目录不存在 / 目录为空

---

💡 **建议**：使用 `/snapshot` 命令创建工作快照，以便将来恢复上下文。
```

---

## ⚠️ 边界条件处理

| 场景 | 处理方式 |
|------|----------|
| 快照目录不存在 | 输出"未检测到快照"提示，结束 |
| 快照目录存在但为空 | 输出"未检测到快照"提示，结束 |
| 非 git 仓库 | 正常读取快照，跳过 git 变更补充部分 |
| git 仓库无变更 | 正常读取快照，git 补充部分显示"无新变更" |

---

## 📌 自动执行

**立即开始执行**：检测快照 → 读取内容 → 生成恢复报告。
